var party=party||{};(function(){var t,F,f,l=0,w,y=0,q={},s=[],n=[],C=[],v=0,p,o={},G=null,D=["#ACE8F1","#2D4891","#F7DC4B","#C52F14"],e={canvas:null,current:0,increment:0},N={input:null,original_caption:null},P={active_bubble_pos:0,keep_bubble_open:false,last_id:0,last_page:0,mosaic_offset:{},initial_tiles_per_frame_incremental:1,draw_new_tiles_every:0,draw_new_tiles_every_counter:0,total_tiles:0,last_tile_drawn_pos:-1},M={high:{initial_frames_per_second:24,initial_tiles_per_frame:10,new_tiles_per_second:8},medium:{initial_frames_per_second:12,initial_tiles_per_frame:20,new_tiles_per_second:4},low:{initial_frames_per_second:1,initial_tiles_per_frame:200,new_tiles_per_second:1}};function k(Q){return Q.replace(/(ftp|http|https|file):\/\/([\S]+(\b|$))/gim,'<a href="$&" class="my_link" target="_blank">$2</a>').replace(/([^\/])(www[\S]+(\b|$))/gim,'$1<a href="http://$2" class="my_link" target="_blank">$2</a>').replace(/(^|\s)@(\w+)/g,'$1<a href="http://twitter.com/$2" class="my_link" target="_blank">@$2</a>').replace(/(^|\s)#(\S+)/g,'$1<a href="http://search.twitter.com/search?q=%23$2" class="my_link" target="_blank">#$2</a>')}function I(S){var Q,R;if(!S){return""}Q=S.p;R=party.mosaic.index[Q];if(!R){return""}return'<div class="tile" id="'+Q+'" style="background-image:url(data:image/gif;base64,'+S.d+"); left: "+(R[0]*12)+"px; top: "+(R[1]*12)+'px;"></div>'}function d(){var Q,R;for(Q=0;Q<v;Q+=1){s.push(Q)}s.shuffle();R=parseInt(v/party.performance.initial_frames_per_second,10);e.increment=parseInt(P.total_tiles/R,10);t=window.setInterval(A,(1000/party.performance.initial_frames_per_second))}function A(){var T="",R=0,Q=0,S;if(P.initial_tiles_per_frame_incremental<party.performance.initial_tiles_per_frame){P.initial_tiles_per_frame_incremental=party.performance.initial_tiles_per_frame}Q=(l+P.initial_tiles_per_frame_incremental);for(R=l;R<Q;R+=1){S=s[R];T=T+I(q[S])}l=R;if(T){party.canvas.append(T);e.current+=e.increment;O()}else{window.clearInterval(t);e.current=parseInt(P.total_tiles,10);O();m();p=window.setInterval(x,(1000/party.performance.new_tiles_per_second))}}function O(){e.canvas.text(number_format(e.current,0,party.l10n.dec_point,party.l10n.thousands_sep))}function B(){var R=$.makeArray($("#loading li")),Q=0,S;R.shuffle();S=function(){$(R[Q]).hide();Q+=1;if(Q>=R.length){Q=0}$(R[Q]).show()};S();F=window.setInterval(S,(party.loading_message_seconds*1000))}function L(){window.clearInterval(F);$("#loading").remove()}function K(){var Q,S=["assets/images/layout/bubble-light-blue.png","assets/images/layout/bubble-dark-blue.png","assets/images/layout/bubble-yellow.png","assets/images/layout/bubble-dark-orange.png"];for(var R=S.length;R--;){(function(){var T=new Image();T.src=S[R]})()}party.performance=party.performance_settings.high;if($.browser.msie){party.performance=party.performance_settings.medium}else{if($.browser.mozilla){if(window.navigator.userAgent.search("Firefox/4")!=-1){$("#download").remove()}}}e.canvas=$("#twitter-counter dd span");G=$("#tile-hover");party.canvas=$("#mosaic");Q=$("#bubble");party.bubble={container:Q,username_a:Q.find("h1 a"),avatar_a:Q.find("a.twitter-avatar"),avatar_img:Q.find("a.twitter-avatar > img"),time:Q.find("time"),time_a:Q.find("time > a"),p:Q.find("p")};P.mosaic_offset=party.canvas.offset();g();j();party.canvas.bind("mouseleave",function(){party.autoBubbleStartTimer=setTimeout(m,1000)});party.canvas.bind("mousemove",function(U){var T,X,W,V=party.canvas.offset();clearTimeout(party.mousemoveTimer);clearTimeout(party.autoBubbleStartTimer);if(P.keep_bubble_open){return}T=Math.ceil((U.clientX+f_scrollLeft()-V.left)/12)-1;X=Math.ceil((U.clientY+f_scrollTop()-V.top)/12)-1;if(T<0||X<0){return}W=party.mosaic.grid[T][X];party.mousemoveTimer=setTimeout(function(){if(W){if(P.active_bubble_pos!=W.i){i();P.active_bubble_pos=W.i;E(W.i)}}else{m()}},50)});G.bind("click",function(T){P.keep_bubble_open=true;T.stopPropagation();return false});party.canvas.bind("click",a);party.bubble.container.bind("click",function(T){if(!P.keep_bubble_open){P.keep_bubble_open=true}i();T.stopPropagation();return(T.target.nodeName.toLowerCase()=="a")});party.bubble.container.bind("mouseenter",function(){G.trigger("click")});party.bubble.container.bind("mouseleave",function(){party.canvas.trigger("click")})}function g(){N.input_dom=$("#search-input");N.original_caption=N.input_dom.val();N.input_dom.focus(function(){if($(this).val()===N.original_caption){$(this).val("")}});N.input_dom.blur(function(){if($(this).val()==""){$(this).val(N.original_caption)}});$("#search-box").submit(function(){var Q=N.input_dom.val();if(Q==""){return false}$("#search-box button").addClass("loading");$.ajax({url:"/tiles-by-username.php",type:"GET",dataType:"json",data:{user_name:Q},success:H});return false})}function H(Q){var S,R;$("#search-box button").removeClass("loading");if(Q.payload.total==0){$("#search-box .error").fadeIn("fast");window.setTimeout(function(){$("#search-box .error").fadeOut("fast")},3*1000);return}S=Q.payload.tiles[0];R=S.p;$.extend(q[R],S);i();P.keep_bubble_open=true;E(R);Q=null}function J(){var Q;Q=n[y];if(!Q){y=0;return}y+=1;E(Q.position)}function m(){if(!w){J();w=setInterval(J,party.auto_bubble_seconds*1000)}}function i(){clearInterval(w);w=null}function E(V){var Y,W,U,X=party.bubble,T,Q,R,S,Z;U=q[V];if(!U||!X){return}R=party.mosaic.index[V];if(!R){return}Y=R[0];W=R[1];S=party.mosaic.grid[Y][W];if(!S){return}if(W>24){if(Y>24){T="bottom-right";Q={top:"",right:(564-(Y*12))+"px",bottom:(532-(W*12))+"px",left:""}}else{T="bottom-left";Q={top:"",right:"",bottom:(532-(W*12))+"px",left:((Y*12)+2)+"px"}}}else{if(Y>24){T="top-right";Q={top:((W*12)-16)+"px",right:(564-(Y*12))+"px",bottom:"",left:""}}else{T="top-left";Q={top:((W*12)-16)+"px",right:"",left:((Y*12)+8)+"px",bottom:""}}}X.container.hide();G.hide();G.attr("src","data:image/gif;base64,"+U.d);G.css({left:(Y*12)+"px",top:(W*12)+"px"});Z=date(party.l10n.date_format,U.c);X.username_a.text(U.u).attr("href","http://twitter.com/"+U.u);X.avatar_a.attr("title",U.u).attr("href","http://twitter.com/"+U.u);X.p.html(k(U.n));X.time_a.attr("href","http://twitter.com/"+U.u+"/status/"+U.w).text(Z);X.time.attr("datetime",Z);X.avatar_img.hide();X.container.css(Q).removeClass().addClass("bubble "+T+" color-"+S.r);party.showBubbleImageTimer=setTimeout(function(){X.avatar_img.attr("src",U.m);X.avatar_img.load(function(){$(this).fadeIn("fast")});party.showBubbleImageTimer=null},500);X.container.show();G.show()}function a(){P.active_bubble_pos=0;P.keep_bubble_open=false;party.bubble.container.hide();G.hide();if(party.showBubbleImageTimer){clearTimeout(party.showBubbleImageTimer);party.showBubbleImageTimer=null}}function c(){window.location=window.location}function j(){if(party.state.last_page==0){setTimeout(c,60*1000);return}B();var Q=party.store_url+"/pages/page_"+party.state.last_page+".json";$.getJSON(Q,function(S){L();if(S.last_id>P.last_id){P.last_id=S.last_id}q=S.tiles;var R;for(R in q){if(q[R].p){n.push({id:parseInt(q[R].i,10),position:parseInt(q[R].p,10)})}}v=n.length;n.sort(function(U,T){return T.id-U.id});n=n.slice(0,199);P.total_tiles=parseInt(party.state.last_page*v,10);d();r();S=null})}function x(){var V,U,Q,R,T,S;if(P.draw_new_tiles_every_counter>=P.draw_new_tiles_every){U=C[0];P.draw_new_tiles_every_counter=0}P.draw_new_tiles_every_counter+=1;if(U){V=parseInt(U.p);if(!q[V]){C.shift();return}T={"background-image":"url(data:image/gif;base64,"+U.d+")"};$.extend(q[V],U);n.shift();n.push({id:parseInt(U.i,10),position:V});C.shift();e.current+=1;O()}else{V=Math.floor(Math.random()*v);Q=party.mosaic.index[V];R=party.mosaic.grid[Q[0]][Q[1]];T={"background-image":"none","background-color":D[R.r]}}if(P.last_tile_drawn_pos>-1){$("#"+P.last_tile_drawn_pos).css({"background-image":"url(data:image/gif;base64,"+q[P.last_tile_drawn_pos].d+")"})}P.last_tile_drawn_pos=V;$("#"+V).css(T)}function r(){z();f=window.setInterval(z,(party.polling_timer_seconds*1000))}function z(){$.ajax({url:"/poll.php",dataType:"json",data:{last_id:P.last_id},success:function(Q){if(Q.payload.last_id>P.last_id){P.last_id=Q.payload.last_id}C=C.concat(Q.payload.tiles.reverse());P.draw_new_tiles_every=Math.round((party.performance.new_tiles_per_second*party.polling_timer_seconds)/C.length);Q=null}})}function u(){return P.last_id}function b(){window.clearInterval(p);window.clearInterval(f)}function h(){r()}$.extend(party,{loading_message_seconds:2,polling_timer_seconds:180,auto_bubble_seconds:7,grid:[],index:[],init:K,getLastId:u,pause:b,resume:h,showBubble:E,performance:o,performance_settings:M,state:P,new_tiles:C})}());$(document).ready(function(){var b=0,a=0;$("#flang").change(function(){window.location="/"+$(this).val()});$("#twitter-counter > dl > dt > a").click(function(){var d=550,f=500,c=(window.screen.width-d)/2,e=(window.screen.height-f)/2;window.open($(this).attr("href"),"tweet","left="+c+",top="+e+",width="+d+",height="+f+",toolbar=0,resizable=1");return false});b=parseInt($("#brand em").width(),10);a=parseInt($("#brand p").width(),10);$("#brand em").before('<span style="left:0; width:'+(a-b)/2+'px" />').fadeIn();$("#brand em").after('<span style="right:0; width:'+(a-b)/2+'px" />').fadeIn();party.init()});